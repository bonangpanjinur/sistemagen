(()=>{"use strict";const e=window.React,t=window.wp.element,n=({onLoginSuccess:t})=>{const[n,o]=(0,e.useState)(""),[a,l]=(0,e.useState)(""),[r,i]=(0,e.useState)(null),[s,u]=(0,e.useState)(!1),c=window.umh_wp_data||{api_url:"/wp-json/umh/v1/"};return(0,e.createElement)("div",{style:m.loginContainer},(0,e.createElement)("div",{style:m.loginBox},(0,e.createElement)("h2",{style:m.loginTitle},"Login Aplikasi"),(0,e.createElement)("p",{style:m.loginSubtitle},"Silakan masuk (Owner/Karyawan)"),(0,e.createElement)("form",{onSubmit:async e=>{e.preventDefault(),u(!0),i(null);try{const e=await fetch(`${c.api_url}users/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:n,password:a})}),o=await e.json();if(!e.ok)throw new Error(o.message||"Login gagal.");t(o)}catch(e){i(e.message),u(!1)}}},(0,e.createElement)("div",{style:m.inputGroup},(0,e.createElement)("label",{htmlFor:"username",style:m.label},"Username atau Email"),(0,e.createElement)("input",{type:"text",id:"username",style:m.input,value:n,onChange:e=>o(e.target.value),required:!0})),(0,e.createElement)("div",{style:m.inputGroup},(0,e.createElement)("label",{htmlFor:"password",style:m.label},"Password"),(0,e.createElement)("input",{type:"password",id:"password",style:m.input,value:a,onChange:e=>l(e.target.value),required:!0})),r&&(0,e.createElement)("p",{style:m.error},r),(0,e.createElement)("button",{type:"submit",style:m.button,disabled:s},s?"Loading...":"Login"))))},o=e=>{const t=async(t,n={})=>{const o=e(),a=window.umh_wp_data||{api_url:"/wp-json/umh/v1/"},l={"Content-Type":"application/json",...n.headers};o&&(l.Authorization=`Bearer ${o}`),window.umh_wp_data?.is_wp_admin&&window.umh_wp_data?.api_nonce&&(l["X-WP-Nonce"]=window.umh_wp_data.api_nonce);const r=await fetch(`${a.api_url}${t}`,{...n,headers:l});if(!r.ok){const e=await r.json();throw new Error(e.message||`Error ${r.status}`)}return 204===r.status?null:r.json()};return{get:(e,n)=>t(e,{...n,method:"GET"}),post:(e,n,o)=>t(e,{...o,method:"POST",body:JSON.stringify(n)}),put:(e,n,o)=>t(e,{...o,method:"PUT",body:JSON.stringify(n)}),del:(e,n)=>t(e,{...n,method:"DELETE"})}},a=(0,e.createContext)(null),l=({children:t})=>{const[n,l]=(0,e.useState)(null),[r,i]=(0,e.useState)(()=>localStorage.getItem("umh_auth_token")),[s,u]=(0,e.useState)(!0),m=o(()=>r);(0,e.useEffect)(()=>{(async()=>{const e=window.umh_wp_data,t=localStorage.getItem("umh_auth_token");try{if(e&&e.is_wp_admin){console.log("Admin WP terdeteksi, mencoba auto-login...");try{const t=await fetch(`${e.api_url}auth/wp-login`,{method:"POST",headers:{"X-WP-Nonce":e.api_nonce,"Content-Type":"application/json"}});if(!t.ok)throw new Error("WP Admin auto-login gagal.");const n=await t.json();console.log("WP Admin auto-login berhasil."),i(n.token),l(n.user),localStorage.setItem("umh_auth_token",n.token)}catch(e){console.error("WP Admin auto-login error:",e),localStorage.removeItem("umh_auth_token"),i(null),l(null)}}else if(t){console.log("Token lokal ditemukan, memverifikasi...");try{const e=o(()=>t),n=await e.get("users/me");console.log("Verifikasi token berhasil."),l(n),i(t)}catch(e){console.warn("Verifikasi token gagal:",e),localStorage.removeItem("umh_auth_token"),i(null),l(null)}}else console.log("Bukan admin & tidak ada token. Tampilkan login.")}catch(e){console.error("Bootstrap auth error:",e),localStorage.removeItem("umh_auth_token"),i(null),l(null)}finally{u(!1)}})()},[]);const c={user:n,token:r,isLoading:s,api:m,logout:()=>{console.log("Logout."),i(null),l(null),localStorage.removeItem("umh_auth_token")},login:e=>{console.log("Login kustom berhasil."),i(e.token),l(e.user),localStorage.setItem("umh_auth_token",e.token)}};return(0,e.createElement)(a.Provider,{value:c},t)},r=()=>{const t=(0,e.useContext)(a);if(null===t)throw new Error("useAuth harus digunakan di dalam AuthProvider");return t},i=()=>{const{user:t,logout:n,api:o}=r(),[a,l]=(0,e.useState)(null),[i,s]=(0,e.useState)(!1);return(0,e.createElement)("div",{style:{padding:"20px"}},(0,e.createElement)("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid #ccc",paddingBottom:"10px"}},(0,e.createElement)("h1",null,"Dashboard React"),(0,e.createElement)("div",null,(0,e.createElement)("span",null,"Halo, ",(0,e.createElement)("strong",null,t?.full_name||t?.username)," (",t?.role,")"),(0,e.createElement)("button",{onClick:n,style:{marginLeft:"15px"}},"Logout"))),(0,e.createElement)("main",{style:{marginTop:"20px"}},(0,e.createElement)("h2",null,"Konten Dashboard"),(0,e.createElement)("p",null,"Ini adalah area dashboard yang aman."),(0,e.createElement)("button",{onClick:async()=>{s(!0);try{const e=await o.get("jamaah");l(e)}catch(e){console.error("Gagal mengambil data jamaah:",e),(e.message.includes("401")||e.message.includes("Token"))&&n()}finally{s(!1)}},disabled:i},i?"Memuat...":"Test Ambil Data Jamaah (Aman)"),a&&(0,e.createElement)("div",{style:{marginTop:"15px"}},(0,e.createElement)("h3",null,"Data Jamaah (Contoh):"),(0,e.createElement)("pre",{style:{background:"#f4f4f4",padding:"10px",maxHeight:"300px",overflowY:"auto",border:"1px solid #ddd",borderRadius:"4px"}},JSON.stringify(a,null,2)))))},s=()=>{const{user:t,isLoading:o,login:a}=r();return o?(0,e.createElement)("div",{style:m.loading},"Memuat Autentikasi..."):t?(0,e.createElement)(i,null):(0,e.createElement)(n,{onLoginSuccess:a})},u=document.getElementById("umh-react-app-root");u&&(0,t.createRoot)(u).render((0,e.createElement)(l,null,(0,e.createElement)(s,null)));const m={loginContainer:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"80vh",backgroundColor:"#f9f9f9"},loginBox:{padding:"40px",backgroundColor:"#ffffff",borderRadius:"8px",boxShadow:"0 4px 12px rgba(0,0,0,0.05)",width:"100%",maxWidth:"400px",textAlign:"center"},loginTitle:{fontSize:"24px",fontWeight:"600",margin:"0 0 10px"},loginSubtitle:{fontSize:"14px",color:"#666",marginBottom:"30px"},inputGroup:{marginBottom:"20px",textAlign:"left"},label:{display:"block",marginBottom:"5px",fontSize:"13px",fontWeight:"500",color:"#333"},input:{width:"100%",padding:"10px 12px",fontSize:"14px",border:"1px solid #ddd",borderRadius:"4px",boxSizing:"border-box"},button:{width:"100%",padding:"12px",fontSize:"15px",fontWeight:"600",color:"#fff",backgroundColor:"#007cba",border:"none",borderRadius:"4px",cursor:"pointer",transition:"background-color 0.2s"},error:{color:"#d93030",fontSize:"13px",marginBottom:"15px"},loading:{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"80vh",fontSize:"18px",fontWeight:"500"}}})();